{% extends "base_dash.html" %}
{% load static %}
{% block content %}
<div class="content-wrapper">
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Edit Produk Modul</h1>
        </div>
      </div>
    </div>
  </section>

  <section class="content">
    <div class="container-fluid">
      <form method="post">
        {% csrf_token %}

        <!-- ===================== MODUL FORM ===================== -->
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">Informasi Modul</h3>
          </div>
          <div class="card-body">

            <!-- Name Field -->
            <div class="form-floating mb-3">
              <input type="text" name="name" id="id_name" value="{{ form.name.value|default_if_none:'' }}"
                class="form-control" placeholder="Nama Modul">
              <label for="id_name">Nama Modul</label>
              {% if form.name.errors %}
              <div class="text-danger small mt-1">{{ form.name.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- URL Path Field -->
            <div class="form-floating mb-3">
              <input type="text" name="url_path" id="id_url_path" value="{{ form.url_path.value|default_if_none:'' }}"
                class="form-control" placeholder="URL Path">
              <label for="id_url_path">URL Path</label>
              {% if form.url_path.errors %}
              <div class="text-danger small mt-1">{{ form.url_path.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Description Field -->
            <div class="form-floating mb-3">
              <textarea name="description" id="id_description" class="form-control" placeholder="Deskripsi"
                style="height: 100px">{{ form.description.value|default_if_none:'' }}</textarea>
              <label for="id_description">Deskripsi</label>
              {% if form.description.errors %}
              <div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Version Field -->
            <div class="form-floating mb-3">
              <input type="text" name="version" id="id_version" value="{{ form.version.value|default_if_none:'' }}"
                class="form-control" placeholder="Versi">
              <label for="id_version">Versi</label>
              {% if form.version.errors %}
              <div class="text-danger small mt-1">{{ form.version.errors.0 }}</div>
              {% endif %}
            </div>

          </div>
        </div>

        <!-- ===================== FORMSET TABLE ===================== -->
        {{ formset.management_form }}

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Daftar Produk</h3>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>Nama Produk</th>
                    <th>Harga</th>
                    <th>Stok</th>
                    {% if user.is_authenticated and user.userprofile.role == 'manager' %}
                    <th>Hapus?</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for product_form in formset %}
                  {% for hidden in product_form.hidden_fields %}
                  {{ hidden }}
                  {% endfor %}
                  <tr>
                    <td>
                      <input type="text" name="{{ product_form.name.html_name }}"
                        id="{{ product_form.name.id_for_label }}"
                        value="{{ product_form.name.value|default_if_none:'' }}" class="form-control"
                        placeholder="Nama Produk">
                      {% if product_form.name.errors %}
                      <div class="text-danger small mt-1">{{ product_form.name.errors.0 }}</div>
                      {% endif %}
                    </td>
                    <td>
                      <input type="number" name="{{ product_form.price.html_name }}"
                        id="{{ product_form.price.id_for_label }}"
                        value="{{ product_form.price.value|default_if_none:'' }}" class="form-control"
                        placeholder="Harga">
                      {% if product_form.price.errors %}
                      <div class="text-danger small mt-1">{{ product_form.price.errors.0 }}</div>
                      {% endif %}
                    </td>
                    <td>
                      <input type="number" name="{{ product_form.stock.html_name }}"
                        id="{{ product_form.stock.id_for_label }}"
                        value="{{ product_form.stock.value|default_if_none:'' }}" class="form-control"
                        placeholder="Stok">
                      {% if product_form.stock.errors %}
                      <div class="text-danger small mt-1">{{ product_form.stock.errors.0 }}</div>
                      {% endif %}
                    </td>
                    {% if user.is_authenticated and user.userprofile.role == 'manager' %}
                    <td class="text-center">
                      {{ product_form.DELETE }}
                    </td>
                    {% endif %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ===================== BUTTONS ===================== -->
        <div class="mt-3 d-grid gap-2">
          <button type="submit" class="btn btn-success" onclick="return confirmBeforeDelete();">
            <i class="fas fa-save"></i> Simpan Perubahan
          </button>
        </div>

      </form>

      <br>
      <a href="{% url 'module-list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Kembali ke daftar modul
      </a>
    </div>
  </section>
</div>

<!-- ===================== JS SCRIPTS ===================== -->
<script>
  const nameInput = document.getElementById("id_name");
  const urlPathInput = document.getElementById("id_url_path");

  function slugify(text) {
    return text
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9\s\-\/]/g, '')
      .replace(/\s+/g, '-')
      .replace(/\/+/g, '/')
      .replace(/\-+/g, '-')
      .replace(/^\-+|\-+$/g, '');
  }

  if (nameInput && urlPathInput) {
    nameInput.addEventListener('input', function () {
      const slug = slugify(this.value);
      if (!urlPathInput.dataset.userEdited) {
        urlPathInput.value = slug;
      }
    });

    urlPathInput.addEventListener('input', function () {
      this.dataset.userEdited = "true";
    });
  }

  function confirmBeforeDelete() {
    const deleteCheckboxes = document.querySelectorAll('input[type="checkbox"][name$="-DELETE"]');
    const anyChecked = Array.from(deleteCheckboxes).some(cb => cb.checked);
    if (anyChecked) {
      return confirm("Apakah Anda yakin ingin menghapus data yang dipilih?");
    }
    return true;
  }
</script>
{% endblock %}